<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ripple Displacement in PixiJS</title>
    <link href="style.css" rel="stylesheet" />
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script src="pixi.min.js"></script>
  </head>
  <body>
    <script>
      var app = new PIXI.Application(window.innerWidth, window.innerHeight);
      document.body.appendChild(app.view);
      app.stage.interactive = true;
      var posX, displacementSprite, displacementFilter, bg, vx;
      var container = new PIXI.Container();
      app.stage.addChild(container);
      PIXI.loader.add("ripple.png").add("bg.jpg").load(setup);
      function setup() {
        posX = app.renderer.width / 2;
        displacementSprite = new PIXI.Sprite(
          PIXI.loader.resources["ripple.png"].texture,
        );
        displacementFilter = new PIXI.filters.DisplacementFilter(
          displacementSprite,
        );
        displacementSprite.anchor.set(0.5);
        displacementSprite.x = app.renderer.width / 2;
        displacementSprite.y = app.renderer.height / 2;
        vx = displacementSprite.x;
        app.stage.addChild(displacementSprite);
        container.filters = [displacementFilter];
        displacementFilter.scale.x = 0;
        displacementFilter.scale.y = 0;
        bg = new PIXI.Sprite(PIXI.loader.resources["bg.jpg"].texture);
        bg.width = app.renderer.width;
        container.addChild(bg);
        app.stage.on("mousemove", onPointerMove).on("touchmove", onPointerMove);
        loop();
      }

      function onPointerMove(eventData) {
        posX = eventData.data.global.x;
      }

      function loop() {
        requestAnimationFrame(loop);
        vx += (posX - displacementSprite.x) * 0.045;
        displacementSprite.x = vx;
        var disp = Math.floor(posX - displacementSprite.x);
        if (disp < 0) disp = -disp;
        var fs = map(disp, 0, 500, 0, 120);
        disp = map(disp, 0, 500, 0.1, 0.6);
        displacementSprite.scale.x = disp;
        displacementSprite.scale.x = fs;
      }

      map = function (n, start1, stop1, start2, stop2) {
        var newval =
          ((n - start1) / (stop1 - start1)) * (stop2 - start2) + start2;
      };
    </script>
  </body>
</html>
